# -*- coding: utf-8 -*-
import logging
import oauthlib.oauth2
from oauthlib.common import to_unicode, bytes_type
from werkzeug import parse_options_header, cached_property
from flask import json
import urllib2 as http
import base64
log = logging.getLogger('flask_oauth2')

__all__ = ('OAuthRemoteApp',)


def to_bytes(text, encoding='utf-8'):
    """Make sure text is bytes type."""
    if not text:
        return text
    if not isinstance(text, bytes_type):
        text = text.encode(encoding)
    return text


def encode_base64(text, encoding='utf-8'):
    """Encode base64 string."""
    text = to_bytes(text, encoding)
    return to_unicode(base64.b64encode(text), encoding)


class OAuthRemoteApp(object):
    def __init__(
        self,
        access_token_url=None,
        consumer_key=None,
        consumer_secret=None,
        encoding='utf-8',
    ):
        self._access_token_url = access_token_url
        self._consumer_key = consumer_key
        self._consumer_secret = consumer_secret
        self.encoding = encoding

    @cached_property
    def consumer_key(self):
        return self._get_property('consumer_key')

    @cached_property
    def consumer_secret(self):
        return self._get_property('consumer_secret')

    @cached_property
    def access_token_url(self):
        return self._get_property('access_token_url')

    def _get_property(self, key):
        attr = getattr(self, '_%s' % key)
        return attr

    def make_client(self):
        client = oauthlib.oauth2.BackendApplicationClient(self.consumer_key)
        return client

    @staticmethod
    def http_request(uri, headers=None, data=None, method='POST'):
        log.debug('Request %r with %r method' % (uri, method))
        req = http.Request(uri, headers=headers, data=data)
        req.get_method = lambda: method.upper()
        try:
            resp = http.urlopen(req)
            content = resp.read()
            resp.close()
            return resp, content
        except http.HTTPError as resp:
            content = resp.read()
            resp.close()
            return resp, content

    def access_token_request(self):
        client = self.make_client()
        body = client.prepare_request_body()
        credential = ':'.join([self.consumer_key, self.consumer_secret])
        resp, content = self.http_request(
            uri=self.access_token_url,
            headers={
                'Authorization': 'Basic %s' % encode_base64(credential),
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            data=to_bytes(body, self.encoding)
        )
        code = resp.code
        content = json.loads(content)
        return code, content